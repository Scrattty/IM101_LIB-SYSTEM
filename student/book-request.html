<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book Request - Library Management System</title>
  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="../css/student.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <img src="../assets/logo.png" alt="Library Logo" class="sidebar-logo">
        <h3>Library System</h3>
      </div>
      
      <nav class="sidebar-nav">
        <ul>
          <li>
            <a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
          </li>
          <li>
            <a href="transactions.html"><i class="fas fa-exchange-alt"></i> Transactions</a>
          </li>
          <li class="active">
            <a href="book-request.html"><i class="fas fa-book"></i> Book Request</a>
          </li>
          <li>
            <a href="room-reservation.html"><i class="fas fa-door-open"></i> Room Reservation</a>
          </li>
          <li>
            <a href="announcements.html"><i class="fas fa-bullhorn"></i> Announcements</a>
          </li>
        </ul>
      </nav>
    </aside>
    
    <!-- Main Content -->
    <main class="main-content">
      <!-- Top Navigation -->
      <header class="top-nav">
        <div class="search-container">
          <input type="text" placeholder="Search books...">
          <button type="button"><i class="fas fa-search"></i></button>
        </div>
        
        <div class="user-menu">
          <div class="notifications">
            <button class="icon-btn"><i class="fas fa-bell"></i></button>
          </div>
          
          <div class="profile-dropdown">
            <button class="profile-toggle">
              <img src="../assets/images/default-profile.png" alt="Profile" id="user-profile-img">
              <span id="user-name">Fatima Briones</span>
              <i class="fas fa-chevron-down"></i>
            </button>
            
            <div class="dropdown-menu">
              <a href="#" id="edit-profile"><i class="fas fa-user-edit"></i> Edit Profile</a>
              <a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
          </div>
        </div>
      </header>
      
      <!-- Content Area -->
      <div class="content">
        <h1 class="page-title">Book Request</h1>
        
        <!-- Category Filter -->
        <div class="filters-container">
          <div class="category-filter">
            <button class="category-btn active" data-category="all">All Types</button>
            <button class="category-btn" data-category="physical">Physical Books</button>
            <button class="category-btn" data-category="ebook">E-Books</button>
          </div>
          
          <div class="location-filter">
            <button class="location-btn active" data-location="all">All Locations</button>
            <button class="location-btn" data-location="san-bartolome">San Bartolome</button>
            <button class="location-btn" data-location="san-francisco">San Francisco</button>
            <button class="location-btn" data-location="batasan">Batasan</button>
          </div>
        </div>
        
        <!-- Book Grid -->
        <div class="book-grid">
          <!-- Physical Book Card -->
          <div class="book-card" data-category="physical" data-location="san-bartolome">
            <div class="book-cover">
              <img src="https://covers.openlibrary.org/b/id/8091016-L.jpg" alt="Book Cover">
              <div class="book-status low-stock">
                Low Stock: 3 copies
              </div>
              <div class="book-type">
                <i class="fas fa-book" title="Physical Book"></i>
              </div>
            </div>
            <div class="book-info">
              <h3>Introduction to Algorithms</h3>
              <p class="book-author">Thomas H. Cormen, Charles E. Leiserson, Ronald L. Rivest</p>
              <p class="book-details">
                <span class="book-category">Computer Science</span>
                <span class="book-location">San Bartolome</span>
              </p>
              <button class="btn btn-primary btn-block request-btn" 
                      data-book-id="1" 
                      data-book-title="Introduction to Algorithms"
                      data-book-author="Thomas H. Cormen, Charles E. Leiserson, Ronald L. Rivest"
                      data-book-cover="https://covers.openlibrary.org/b/id/8091016-L.jpg"
                      data-book-type="physical">
                Request Book
              </button>
            </div>
          </div>

          <!-- E-Book Card -->
          <div class="book-card" data-category="ebook" data-location="all">
            <div class="book-cover">
              <img src="https://covers.openlibrary.org/b/id/8091016-L.jpg" alt="Book Cover">
              <div class="book-status available">
                Available for Download
              </div>
              <div class="book-type">
                <i class="fas fa-tablet-alt" title="E-Book"></i>
              </div>
            </div>
            <div class="book-info">
              <h3>Introduction to Algorithms</h3>
              <p class="book-author">Thomas H. Cormen, Charles E. Leiserson, Ronald L. Rivest</p>
              <p class="book-details">
                <span class="book-category">Computer Science</span>
                <span class="book-format">E-Book</span>
              </p>
              <button class="btn btn-primary btn-block request-btn"
                      data-book-id="1e"
                      data-book-title="Introduction to Algorithms"
                      data-book-author="Thomas H. Cormen, Charles E. Leiserson, Ronald L. Rivest"
                      data-book-cover="https://covers.openlibrary.org/b/id/8091016-L.jpg"
                      data-book-type="ebook">
                Request E-Book
              </button>
            </div>
          </div>
          
          <!-- Physical Book Card -->
          <div class="book-card" data-category="physical" data-location="san-francisco">
            <div class="book-cover">
              <img src="https://covers.openlibrary.org/b/id/8522667-L.jpg" alt="Book Cover">
              <div class="book-status available">
                Available: 15 copies
              </div>
              <div class="book-type">
                <i class="fas fa-book" title="Physical Book"></i>
              </div>
            </div>
            <div class="book-info">
              <h3>Clean Code</h3>
              <p class="book-author">Robert C. Martin</p>
              <p class="book-details">
                <span class="book-category">Computer Science</span>
                <span class="book-location">San Francisco</span>
              </p>
              <button class="btn btn-primary btn-block request-btn"
                      data-book-id="2"
                      data-book-title="Clean Code"
                      data-book-author="Robert C. Martin"
                      data-book-cover="https://covers.openlibrary.org/b/id/8522667-L.jpg"
                      data-book-type="physical">
                Request Book
              </button>
            </div>
          </div>

          <!-- E-Book Card -->
          <div class="book-card" data-category="ebook" data-location="all">
            <div class="book-cover">
              <img src="https://covers.openlibrary.org/b/id/8522667-L.jpg" alt="Book Cover">
              <div class="book-status available">
                Available for Download
              </div>
              <div class="book-type">
                <i class="fas fa-tablet-alt" title="E-Book"></i>
              </div>
            </div>
            <div class="book-info">
              <h3>Clean Code</h3>
              <p class="book-author">Robert C. Martin</p>
              <p class="book-details">
                <span class="book-category">Computer Science</span>
                <span class="book-format">E-Book</span>
              </p>
              <button class="btn btn-primary btn-block request-btn"
                      data-book-id="2e"
                      data-book-title="Clean Code"
                      data-book-author="Robert C. Martin"
                      data-book-cover="https://covers.openlibrary.org/b/id/8522667-L.jpg"
                      data-book-type="ebook">
                Request E-Book
              </button>
            </div>
          </div>
          
          <!-- Physical Book Card -->
          <div class="book-card" data-category="physical" data-location="batasan">
            <div class="book-cover">
              <img src="https://covers.openlibrary.org/b/id/8051880-L.jpg" alt="Book Cover">
              <div class="book-status out-of-stock">
                Out of Stock
              </div>
              <div class="book-type">
                <i class="fas fa-book" title="Physical Book"></i>
              </div>
            </div>
            <div class="book-info">
              <h3>Artificial Intelligence: A Modern Approach</h3>
              <p class="book-author">Stuart Russell, Peter Norvig</p>
              <p class="book-details">
                <span class="book-category">Computer Science</span>
                <span class="book-location">Batasan</span>
              </p>
              <button class="btn btn-secondary btn-block" disabled>Request Book</button>
            </div>
          </div>

          <!-- E-Book Card -->
          <div class="book-card" data-category="ebook" data-location="all">
            <div class="book-cover">
              <img src="https://covers.openlibrary.org/b/id/8051880-L.jpg" alt="Book Cover">
              <div class="book-status available">
                Available for Download
              </div>
              <div class="book-type">
                <i class="fas fa-tablet-alt" title="E-Book"></i>
              </div>
            </div>
            <div class="book-info">
              <h3>Artificial Intelligence: A Modern Approach</h3>
              <p class="book-author">Stuart Russell, Peter Norvig</p>
              <p class="book-details">
                <span class="book-category">Computer Science</span>
                <span class="book-format">E-Book</span>
              </p>
              <button class="btn btn-primary btn-block request-btn"
                      data-book-id="3e"
                      data-book-title="Artificial Intelligence: A Modern Approach"
                      data-book-author="Stuart Russell, Peter Norvig"
                      data-book-cover="https://covers.openlibrary.org/b/id/8051880-L.jpg"
                      data-book-type="ebook">
                Request E-Book
              </button>
            </div>
          </div>
        </div>
        
        <!-- Pagination -->
        <div class="pagination">
          <button class="pagination-btn"><i class="fas fa-chevron-left"></i></button>
          <button class="pagination-btn active">1</button>
          <button class="pagination-btn">2</button>
          <button class="pagination-btn">3</button>
          <span class="pagination-ellipsis">...</span>
          <button class="pagination-btn">10</button>
          <button class="pagination-btn"><i class="fas fa-chevron-right"></i></button>
        </div>
      </div>
    </main>
    
    <!-- Book Request Modal -->
    <div class="modal" id="request-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modal-request-title">Request Book</h2>
          <button class="close-modal">&times;</button>
        </div>
        
        <div class="modal-body">
          <div class="book-preview">
            <img src="" alt="Book Cover" id="modal-book-cover">
            <div class="book-details">
              <h3 id="modal-book-title"></h3>
              <p id="modal-book-author"></p>
              <p id="modal-book-type" class="book-type-label"></p>
            </div>
          </div>
          
          <div class="form-group" id="pickup-date-container">
            <label for="pickup-date">Preferred Pickup Date</label>
            <input type="date" id="pickup-date" class="form-control">
            <p class="help-text">For physical books, please select a date to pick up your book.</p>
          </div>
          
          <div class="form-group" id="email-container" style="display: none;">
            <label for="email-confirm">Confirm Email for Notifications</label>
            <input type="email" id="email-confirm" class="form-control" value="fatima.briones@example.edu" readonly>
            <p class="help-text">We'll send you the download link for the e-book to this email address.</p>
          </div>
          
          <div class="form-group">
            <label for="request-notes">Notes (Optional)</label>
            <textarea id="request-notes" class="form-control" rows="3" placeholder="Any special requests or notes"></textarea>
          </div>
          
          <div class="agreement-checkbox">
            <input type="checkbox" id="terms-agreement">
            <label for="terms-agreement">I understand that all materials are for borrowing purposes only and may not be reproduced or distributed.</label>
          </div>
        </div>
        
        <div class="modal-footer">
          <button class="btn btn-secondary close-modal">Cancel</button>
          <button class="btn btn-primary" id="confirm-request" disabled>Submit Request</button>
        </div>
      </div>
    </div>
    
    <!-- Success Modal -->
    <div class="modal" id="success-modal">
      <div class="modal-content">
        <div class="modal-header success">
          <h2>Request Submitted!</h2>
          <button class="close-modal">&times;</button>
        </div>
        
        <div class="modal-body text-center">
          <div class="success-icon">
            <i class="fas fa-check-circle"></i>
          </div>
          <h3>Your request has been submitted successfully!</h3>
          <p>We will notify you via email once your request has been processed.</p>
          <p id="success-message"></p>
        </div>
        
        <div class="modal-footer">
          <button class="btn btn-success close-modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Profile Modal -->
  <div class="modal" id="profile-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Profile</h2>
        <button class="close-modal">&times;</button>
      </div>
      
      <div class="modal-body">
        <form id="profile-form">
          <div class="profile-photo-container">
            <img src="../assets/images/default-profile.png" alt="Profile Photo" id="profile-preview">
            <div class="photo-upload">
              <label for="profile-photo" class="btn btn-secondary">
                <i class="fas fa-camera"></i> Change Photo
              </label>
              <input type="file" id="profile-photo" accept="image/*" hidden>
              <p class="help-text">Max file size: 2MB. Supported formats: JPG, PNG</p>
            </div>
          </div>
          
          <div class="form-group">
            <label for="profile-id">Student/Employee Number</label>
            <div class="disabled-field">
              <input type="text" id="profile-id" class="form-control" disabled readonly>
              <i class="fas fa-lock"></i>
            </div>
            <p class="help-text">This is your permanent identification number and cannot be changed</p>
          </div>
          
          <div class="form-group">
            <label>Name</label>
            <div class="name-fields">
              <div class="form-group">
                <input type="text" id="profile-lastname" class="form-control" placeholder="Last Name" required>
              </div>
              <div class="form-group">
                <input type="text" id="profile-firstname" class="form-control" placeholder="First Name" required>
              </div>
              <div class="form-group">
                <input type="text" id="profile-middlename" class="form-control" placeholder="Middle Name (Optional)">
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="profile-email">Email Address</label>
            <input type="email" id="profile-email" class="form-control" required>
          </div>
          
          <div class="form-group">
            <label for="profile-current-password">Current Password</label>
            <input type="password" id="profile-current-password" class="form-control" required>
            <p class="help-text">Enter your current password to confirm changes</p>
          </div>
          
          <div class="form-group">
            <label for="profile-new-password">New Password</label>
            <input type="password" id="profile-new-password" class="form-control" minlength="8">
            <p class="help-text">Leave blank to keep current password. Minimum 8 characters.</p>
          </div>
        </form>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancel-profile-edit">Cancel</button>
        <button class="btn btn-primary" id="save-profile" form="profile-form">Save Changes</button>
      </div>
    </div>
  </div>

  <script src="../js/student.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Function to fetch available books from the database
      function fetchAvailableBooks() {
        fetch('get_available_books.php')
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success') {
              renderBooks(data.books);
            } else {
              console.error('Error fetching books:', data.message);
              Swal.fire('Error', 'Failed to load books. Please try again later.', 'error');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            Swal.fire('Error', 'Failed to load books. Please try again later.', 'error');
          });
      }

      // Function to render books in the table
      function renderBooks(books) {
        const tbody = document.getElementById('books-table-body');
        tbody.innerHTML = '';

        books.forEach(book => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>
              <img src="${book.image_path || 'https://covers.openlibrary.org/b/id/8091016-S.jpg'}" 
                   alt="Book Cover" class="book-thumbnail">
            </td>
            <td>${book.title}</td>
            <td>${book.authors}</td>
            <td>${book.isbn || 'N/A'}</td>
            <td>${book.subject}</td>
            <td data-location="${book.location}">
              ${book.location.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
            </td>
            <td><span class="stock-badge ${getStockStatusClass(book.copies)}">${book.copies}</span></td>
            <td>
              <button class="btn-icon view-book" data-id="${book.id}" title="View Details">
                <i class="fas fa-eye"></i>
              </button>
              <button class="btn-icon request-book" data-id="${book.id}" title="Request Book">
                <i class="fas fa-book-reader"></i>
              </button>
            </td>
          `;
          tbody.appendChild(row);
        });

        // Add event listeners for the buttons
        addBookButtonListeners();
      }

      // Function to get stock status class
      function getStockStatusClass(copies) {
        const stock = parseInt(copies);
        if (stock === 0) return 'out';
        if (stock <= 3) return 'low';
        return 'good';
      }

      // Function to add event listeners to book action buttons
      function addBookButtonListeners() {
        // View book details
        document.querySelectorAll('.view-book').forEach(button => {
          button.addEventListener('click', function() {
            const bookId = this.dataset.id;
            fetch(`get_book.php?id=${bookId}`)
              .then(response => response.json())
              .then(data => {
                if (data.status === 'success') {
                  const book = data.book;
                  Swal.fire({
                    title: book.title,
                    html: `
                      <div class="book-details" style="text-align: left;">
                        <img src="${book.image_path || 'https://covers.openlibrary.org/b/id/8091016-S.jpg'}" 
                             alt="Book Cover" style="max-width: 200px; margin-bottom: 20px;">
                        <p><strong>Authors:</strong> ${book.authors}</p>
                        <p><strong>ISBN:</strong> ${book.isbn || 'N/A'}</p>
                        <p><strong>Publisher:</strong> ${book.publisher || 'N/A'}</p>
                        <p><strong>Publication Year:</strong> ${book.publication_year || 'N/A'}</p>
                        <p><strong>Edition:</strong> ${book.edition || 'N/A'}</p>
                        <p><strong>Subject:</strong> ${book.subject}</p>
                        <p><strong>Location:</strong> ${book.location.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</p>
                        <p><strong>Copies Available:</strong> ${book.copies}</p>
                        <p><strong>Description:</strong> ${book.description || 'No description available'}</p>
                      </div>
                    `,
                    width: '600px',
                    showCloseButton: true,
                    showConfirmButton: false
                  });
                } else {
                  Swal.fire('Error', 'Could not load book details', 'error');
                }
              })
              .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'Could not load book details', 'error');
              });
          });
        });

        // Request book
        document.querySelectorAll('.request-book').forEach(button => {
          button.addEventListener('click', function() {
            const bookId = this.dataset.id;
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            if (!currentUser) {
              Swal.fire('Error', 'Please log in to request a book', 'error');
              return;
            }

            Swal.fire({
              title: 'Request Book',
              text: 'Are you sure you want to request this book?',
              icon: 'question',
              showCancelButton: true,
              confirmButtonColor: '#3085d6',
              cancelButtonColor: '#d33',
              confirmButtonText: 'Yes, request it!'
            }).then((result) => {
              if (result.isConfirmed) {
                const formData = new FormData();
                formData.append('book_id', bookId);
                formData.append('user_id', currentUser.user_id);
                
                fetch('request_book.php', {
                  method: 'POST',
                  body: formData
                })
                .then(response => response.json())
                .then(data => {
                  if (data.status === 'success') {
                    Swal.fire('Success!', 'Book request submitted successfully!', 'success');
                  } else {
                    Swal.fire('Error!', data.message, 'error');
                  }
                })
                .catch(error => {
                  console.error('Error:', error);
                  Swal.fire('Error!', 'Could not submit book request.', 'error');
                });
              }
            });
          });
        });
      }

      // Initial load of books
      fetchAvailableBooks();

      // Get DOM elements for filters
      const categoryButtons = document.querySelectorAll('.category-btn');
      const searchInput = document.querySelector('.search-container input');
      const subjectFilter = document.getElementById('subject-filter');
      const availabilityFilter = document.getElementById('availability-filter');
      const applyFiltersBtn = document.querySelector('.filter-container .btn-primary');
      const resetFiltersBtn = document.querySelector('.filter-container .btn-secondary');

      // Function to check stock status
      function getStockStatus(stockElement) {
        const stockText = stockElement.textContent.trim();
        const stockNumber = parseInt(stockText);
        
        if (stockNumber === 0) return 'out-of-stock';
        if (stockNumber <= 3) return 'low-stock';
        return 'available';
      }

      // Function to normalize subject text for comparison
      function normalizeSubject(subject) {
        return subject.toLowerCase().replace(/\s+/g, '-');
      }

      // Function to apply all filters
      function applyAllFilters() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const selectedSubject = subjectFilter.value;
        const selectedAvailability = availabilityFilter.value;
        const activeLocation = document.querySelector('.category-btn.active').dataset.category;

        const bookRows = document.querySelectorAll('#books-table-body tr');

        bookRows.forEach(row => {
          // Get all searchable content
          const title = row.cells[1].textContent.toLowerCase();
          const author = row.cells[2].textContent.toLowerCase();
          const isbn = row.cells[3].textContent.toLowerCase();
          const subject = normalizeSubject(row.cells[4].textContent);
          const location = row.cells[5].textContent.toLowerCase();
          const stockStatus = getStockStatus(row.cells[6].querySelector('.stock-badge'));

          // Check all filter conditions
          const matchesSearch = searchTerm === '' || 
              title.includes(searchTerm) ||
              author.includes(searchTerm) ||
              isbn.includes(searchTerm) ||
              subject.includes(searchTerm) ||
              location.includes(searchTerm);

          const matchesSubject = selectedSubject === 'all' || 
              normalizeSubject(selectedSubject) === subject;

          const matchesAvailability = selectedAvailability === 'all' || 
              stockStatus === selectedAvailability;

          const matchesLocation = activeLocation === 'all' || 
              row.cells[5].dataset.location === activeLocation;

          // Show/hide row based on all conditions
          row.style.display = (matchesSearch && matchesSubject && matchesAvailability && matchesLocation) ? '' : 'none';
        });

        // Update the subject filter options based on available subjects
        updateSubjectFilterOptions();
      }

      // Function to update subject filter options based on visible rows
      function updateSubjectFilterOptions() {
        const visibleSubjects = new Set();
        const bookRows = document.querySelectorAll('#books-table-body tr');
        
        bookRows.forEach(row => {
          if (row.style.display !== 'none') {
            const subject = row.cells[4].textContent.trim();
            visibleSubjects.add(subject);
          }
        });

        // Update the subject filter options
        const currentValue = subjectFilter.value;
        subjectFilter.innerHTML = '<option value="all">All Subjects</option>';
        
        // Add options for each unique subject
        Array.from(visibleSubjects).sort().forEach(subject => {
          const option = document.createElement('option');
          option.value = normalizeSubject(subject);
          option.textContent = subject;
          subjectFilter.appendChild(option);
        });

        // Restore the selected value if it still exists
        if (currentValue && Array.from(visibleSubjects).some(s => normalizeSubject(s) === currentValue)) {
          subjectFilter.value = currentValue;
        }
      }

      // Add event listeners for filters
      subjectFilter.addEventListener('change', applyAllFilters);
      availabilityFilter.addEventListener('change', applyAllFilters);

      // Apply filters button
      if (applyFiltersBtn) {
        applyFiltersBtn.addEventListener('click', applyAllFilters);
      }

      // Reset filters button
      if (resetFiltersBtn) {
        resetFiltersBtn.addEventListener('click', function() {
          // Reset all filters to default values
          searchInput.value = '';
          subjectFilter.value = 'all';
          availabilityFilter.value = 'all';
          
          // Reset location filter to 'all'
          categoryButtons.forEach(btn => {
            if (btn.dataset.category === 'all') {
              btn.classList.add('active');
            } else {
              btn.classList.remove('active');
            }
          });

          // Apply the reset filters
          applyAllFilters();
        });
      }

      // Search input event listener
      searchInput.addEventListener('input', applyAllFilters);

      // Location filter event listeners
      categoryButtons.forEach(button => {
        button.addEventListener('click', function() {
          categoryButtons.forEach(btn => btn.classList.remove('active'));
          this.classList.add('active');
          applyAllFilters();
        });
      });
    });
  </script>
</body>
</html>